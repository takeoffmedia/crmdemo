angular.module("security",[]).constant("security.urls",{site:"/",join:"/api/account/register",login:"/token",logout:"/api/account/logout"}).factory("security.api",["$http","security.urls",function(n,t){var i={"Content-Type":"application/x-www-form-urlencoded"},r=function(n){var t=function(n){var i="",e,f,r,u;return angular.forEach(n,function(n,o){if(n instanceof Array)for(u=0;u<n.length;++u)e=n[u],f=o+"["+u+"]",r={},r[f]=e,i+=t(r)+"&";else n instanceof Object?angular.forEach(n,function(n,u){f=o+"["+u+"]";r={};r[f]=n;i+=t(r)+"&"}):n!==undefined&&n!==null&&(i+=encodeURIComponent(o)+"="+encodeURIComponent(n)+"&")}),i.length?i.substr(0,i.length-1):i};return angular.isObject(n)&&String(n)!=="[object File]"?t(n):n};return{login:function(u){return n({method:"POST",url:t.login,data:r(u),headers:i})},logout:function(){return n({method:"POST",url:t.logout})},register:function(i){return n({method:"POST",url:t.join,data:i})}}}]).provider("security",["security.urls",function(n){var t=this;t.registerThenLogin=!0;t.usePopups=!1;t.urls={login:"/login",postLogout:"/login",home:"/"};t.apiUrls=n;t.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null};t.$get=["security.api","$q","$http","$location","$timeout",function(n,i,r,u){var h=function(n){var u={},f,t,i,e,o,s,h,r;if(n===null)return u;for(f=n.split("&"),r=0;r<f.length;r++)t=f[r],i=t.indexOf("="),i===-1?(e=t,o=null):(e=t.substr(0,i),o=t.substr(i+1)),s=decodeURIComponent(e),h=decodeURIComponent(o),u[s]=h;return u},e=function(n,t){return n&&(n=="clear"?(localStorage.removeItem("accessToken"),sessionStorage.removeItem("accessToken"),delete r.defaults.headers.common.Authorization):(t?localStorage.accessToken=n:sessionStorage.accessToken=n,r.defaults.headers.common.Authorization="Bearer "+n)),sessionStorage.accessToken||localStorage.accessToken},o=function(n){if(n=="clear"){delete localStorage.redirectTarget;return}return n&&(localStorage.redirectTarget=n),localStorage.redirectTarget},s=function(){e()&&e(e())},f=this;return f.user=null,f.externalUser=null,f.externalLogins=[],f.login=function(r){var u=i.defer();return r.grant_type="password",n.login(r).success(function(n){e(n.access_token,r.rememberMe);f.user=n;f.redirectAuthenticated(o()||t.urls.home);t.events.login&&t.events.login(f,n);u.resolve(f.user)}).error(function(n){u.reject(n)}),u.promise},f.logout=function(){var r=i.defer();return n.logout().success(function(){f.user=null;e("clear");o("clear");t.events.logout&&t.events.logout(f);u.path(t.urls.postLogout);r.resolve()}).error(function(n){r.reject(n)}),r.promise},f.register=function(r){var u=i.defer();return n.register(r).success(function(){t.events.register&&t.events.register(f);t.registerThenLogin?f.login(r).then(function(n){u.resolve(n)},function(n){u.reject(n)}):u.resolve()}).error(function(n){u.reject(n)}),u.promise},f.authenticate=function(){return e()?!0:(o()||o(u.path()),u.path(t.urls.login),!1)},f.redirectAuthenticated=function(n){e()&&(o()&&o("clear"),u.path(n))},f.accessToken=function(){return e()},s(),f}]}]);